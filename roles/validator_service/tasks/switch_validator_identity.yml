- name: Verifications # noqa run-once[task]
  run_once: true
  block:
    - name: Validate required host variables are provided
      ansible.builtin.assert:
        that:
          - active_host is defined
          - standby_host is defined
          - active_host | string | length > 0
          - standby_host | string | length > 0
        fail_msg: "Both active_host and standby_host must be provided when switching validator identity."
        quiet: true

    - name: Check standby identity file exists on standby host
      become: true
      become_user: "{{ hostvars[standby_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[standby_host].standy_identity_path | default(standy_identity_path) }}"
      delegate_to: "{{ standby_host }}"
      register: standby_identity_stat

    - name: Check standby identity file exists on active host
      become: true
      become_user: "{{ hostvars[active_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[active_host].standy_identity_path | default(standy_identity_path) }}"
      delegate_to: "{{ active_host }}"
      register: standby_identity_on_active_stat

    - name: Check active identity file exists on active host
      become: true
      become_user: "{{ hostvars[active_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[active_host].active_identity_path | default(active_identity_path) }}"
      delegate_to: "{{ active_host }}"
      register: active_identity_stat

    - name: Check active identity file exists on standby host
      become: true
      become_user: "{{ hostvars[standby_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[standby_host].active_identity_path | default(active_identity_path) }}"
      delegate_to: "{{ standby_host }}"
      register: active_identity_on_standby_stat

    - name: Validate identity files exist
      ansible.builtin.assert:
        that:
          - standby_identity_stat.stat.exists
          - standby_identity_on_active_stat.stat.exists
          - active_identity_stat.stat.exists
          - active_identity_on_standby_stat.stat.exists
        fail_msg: |
          Identity files not found on one or both hosts.
          Standby host ({{ standby_host }}): {{ hostvars[standby_host].standy_identity_path | default(standy_identity_path) }} exists? {{ standby_identity_stat.stat.exists | default(false) }}, {{ hostvars[standby_host].active_identity_path | default(active_identity_path) }} exists? {{ active_identity_on_standby_stat.stat.exists | default(false) }}
          Active host ({{ active_host }}): {{ hostvars[active_host].standy_identity_path | default(standy_identity_path) }} exists? {{ standby_identity_on_active_stat.stat.exists | default(false) }}, {{ hostvars[active_host].active_identity_path | default(active_identity_path) }} exists? {{ active_identity_stat.stat.exists | default(false) }}
        quiet: true

    - name: Check tower file exists on active host
      become: true
      become_user: "{{ hostvars[active_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[active_host].ledger_path | default(ledger_path) }}/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin"
      delegate_to: "{{ active_host }}"
      register: tower_file_on_active_stat

    - name: Validate tower file exist
      ansible.builtin.assert:
        that:
          - tower_file_on_active_stat.stat.exists
        fail_msg: |
          The tower file ({{ hostvars[active_host].ledger_path | default(ledger_path) }}/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin) not found on the active host.
        quiet: true

    - name: Check {{ hostvars[active_host].identity_path | default(identity_path) }} exists on active host
      become: true
      become_user: "{{ hostvars[active_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[active_host].identity_path | default(identity_path) }}"
      delegate_to: "{{ active_host }}"
      register: identity_path_on_active_stat

    - name: Check {{ hostvars[standby_host].identity_path | default(identity_path) }} exists on standby host
      become: true
      become_user: "{{ hostvars[standby_host].service_user | default(service_user) }}"
      ansible.builtin.stat:
        path: "{{ hostvars[standby_host].identity_path | default(identity_path) }}"
      delegate_to: "{{ standby_host }}"
      register: identity_path_on_standby_stat

- name: Point identity symlink to standby key on previous active host # noqa run-once[task]
  become: true
  become_user: "{{ hostvars[active_host].service_user | default(service_user) }}"
  ansible.builtin.file:
    src: "{{ hostvars[active_host].standy_identity_path | default(standy_identity_path) }}"
    dest: "{{ hostvars[active_host].identity_path | default(identity_path) }}"
    state: link
    force: true
  delegate_to: "{{ active_host }}"
  run_once: true
  when: identity_path_on_active_stat.stat.islnk is defined and identity_path_on_active_stat.stat.islnk

- name: Set identity to standby on active host # noqa run-once[task]
  ansible.builtin.command:
    cmd: "fdctl --config {{ hostvars[active_host].firedancer_config_path | default(firedancer_config_path) }} set-identity {{ hostvars[active_host].standy_identity_path | default(standy_identity_path) }}"
  delegate_to: "{{ active_host }}"
  changed_when: false
  run_once: true
  register: active_set_identity_result

- name: Fetch tower file from {{ active_host }}
  ansible.posix.synchronize:
    src: "{{ active_host }}:{{ hostvars[active_host].ledger_path | default(ledger_path) }}/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin"
    dest: "./tmp_towerfiles/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin"
    mode: pull
    rsync_opts:
      - "--mkpath" # create target directory if missing, available in newer versions of rsync (3.2.0 and later)
  when: active_host is not none

- name: Verify active host identity switch # noqa run-once[task]
  ansible.builtin.assert:
    that:
      - "'Validator identity key switched to' in active_set_identity_result.stderr"
    fail_msg: |
      Failed to confirm identity switch on {{ active_host }}
      Expected "Validator identity key switched to" message not found in output
    quiet: true
  run_once: true

- name: Copy tower to standby host # noqa run-once[task]
  become: true
  ansible.builtin.copy:
    src: "./tmp_towerfiles/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin"
    dest: "{{ hostvars[standby_host].ledger_path | default(ledger_path) }}/{{ hostvars[active_host].tower_file_prefix | default(tower_file_prefix) }}-{{ hostvars[active_host].identity_pubkey | default(identity_pubkey) }}.bin"
    mode: "0644"
    owner: "{{ hostvars[standby_host].service_user | default(service_user) }}"
    group: "{{ hostvars[standby_host].service_user | default(service_user) }}"
  delegate_to: "{{ standby_host }}"
  run_once: true

- name: Rotate standby identity to active on standby host # noqa run-once[task]
  become: true
  become_user: "{{ hostvars[standby_host].service_user | default(service_user) }}"
  ansible.builtin.command:
    cmd: "fdctl --config {{ hostvars[standby_host].firedancer_config_path | default(firedancer_config_path) }} set-identity --require-tower {{ hostvars[standby_host].active_identity_path | default(active_identity_path) }}"
  delegate_to: "{{ standby_host }}"
  changed_when: false
  run_once: true
  register: standby_set_identity_result

- name: Point identity symlink to active key on new active host # noqa run-once[task]
  become: true
  become_user: "{{ hostvars[standby_host].service_user | default(service_user) }}"
  ansible.builtin.file:
    src: "{{ hostvars[standby_host].active_identity_path | default(active_identity_path) }}"
    dest: "{{ hostvars[standby_host].identity_path | default(identity_path) }}"
    state: link
    force: true
  delegate_to: "{{ standby_host }}"
  run_once: true
  when: identity_path_on_active_stat.stat.islnk is defined and identity_path_on_active_stat.stat.islnk
