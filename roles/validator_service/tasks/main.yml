#SPDX-License-Identifier: MIT ---
# tasks file for fogo_validator
- name: Install the acl package that is needed by Ansible
  become: true
  apt:
    name:
      - acl
    update_cache: yes

- name: Create a service user
  become: true
  user:
    name: "{{ service_user }}"
    shell: "/bin/bash"
    create_home: true
    password: "!"
    state: present

- name: Bootstrap disks (which should be run only once)
  include_tasks: bootstrap_disks.yml
  when: bootstrap_disks

- name: Performance tuning
  include_tasks: performance_tuning.yml

- name: Update UFW settings for Firedancer
  include_tasks: ufw_settings.yml

- name: Update repositories cache and install required libraries
  become: true
  apt:
    name:
      - build-essential
      - clang
      - git
      - make
      - pkgconf
      - cmake
      - libssl-dev
      - libclang-dev
      - libudev-dev
      - protobuf-compiler
    update_cache: yes

- name: Check agave-validator availability (used for gracefully restarting the service)
  shell: 'bash -lc "command -v agave-validator"'
  become: true
  become_user: "{{ service_user }}"
  register: agave_validator_check
  changed_when: false
  failed_when: false
  tags:
    - always

- name: "Build fogo binaries ({{ fogo_binaries_to_build | join(', ') }})"
  include_tasks: build_fogo_binaries.yml
  when: "fogo_binaries_build_mode != 'push'"
  vars:
    temp_source_code_folder: "/home/{{ service_user }}/fogo-{{ validator_client_version }}"
  tags:
    - update_binary

- name: "Push fogo binaries ({{ fogo_binaries_to_build | join(', ') }}) to the host"
  ansible.posix.synchronize:
    src: "{{ fogo_binaries_local_path }}/{{ item }}"
    dest: "/tmp/ansible_fogo_artifacts/{{ item }}"
    mode: push
    rsync_opts:
      - "--mkpath" # create target directory if missing, available in newer versions of rsync (3.2.0 and later)
  loop: "{{ fogo_binaries_to_build }}"
  when: "fogo_binaries_build_mode == 'push'"
  tags:
    - update_binary

- name: "Update fogo binaries ({{ fogo_binaries_to_build | join(', ') }})"
  include_tasks: update_fogo_binaries.yml
  vars:
    temp_binaries_folder: >-
      {{ '/tmp/ansible_fogo_artifacts'
         if fogo_binaries_build_mode == 'push'
         else '/home/' ~ service_user ~ '/fogo-' ~ validator_client_version ~ '/' ~ tarball_top_folder ~ '/build/native/gcc/bin' }}
  tags:
    - update_binary

- name: Generate firedancer config from the template
  become: true
  template:
    src: "{{ firedancer_config_template_path }}"
    dest: "{{ firedancer_config_path }}"
    mode: "0644"
    owner: "{{ service_user }}"
    group: "{{ service_user }}"
  notify:
    - Restart fogo validator service
  tags:
    - update_config

- name: Check the existence of the key files
  block:
    - name: Check if the identity keypair exists
      become: true
      stat:
        path: "{{ identity_path }}"
      register: identity_keypair_stat

    - name: "{{ identity_path }} does not exist, create a new one for now"
      become: true
      become_user: "{{ service_user }}"
      shell: "fdctl --config {{ firedancer_config_path }} keys new {{ identity_path }}"
      when: not identity_keypair_stat.stat.exists
  tags:
    - update_config

- name: Create the systemd service for fogo
  become: true
  template:
    src: "{{ firedancer_systemd_template_path }}"
    dest: "/etc/systemd/system/fogo-validator.service"
    mode: "0644"
  notify:
    - Restart fogo validator service
  tags:
    - update_config

- name: Configure log rotation if Firedancer logs are written to a file
  become: true
  block:
    - name: Ensure logrotate is installed
      ansible.builtin.package:
        name: logrotate
        state: present

    - name: Install logrotate rule for Firedancer
      ansible.builtin.copy:
        dest: /etc/logrotate.d/firedancer
        owner: root
        group: root
        mode: "0644"
        content: |
          {{ firedancer_log_path }} {
            rotate {{ firedancer_log_rotation_days }}
            daily
            missingok
            copytruncate
          }
      notify: Run logrotate now
  when: "firedancer_log_path != '-'"
  tags:
    - update_config

- name: Enable and start fogo validator
  become: true
  systemd_service:
    name: fogo-validator
    daemon_reload: true
    enabled: true
    state: started
  tags:
    - update_config

- name: Configure Solana CLI
  include_tasks: configure_solana_cli.yml
  tags:
    - solana_cli
